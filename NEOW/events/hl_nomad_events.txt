namespace = HL

######################################
# Nomad Cultural Preservation Events #
######################################

character_event = {
	id = HL.4994
	desc = EVTDESC_HL_4994
	picture = GFX_evt_horsemanship

	is_triggered_only = yes

	option = {
		name = EXCELLENT

		reverse_opinion = {
			name = opinion_loyal_servant
			who = event_target:new_nomad
			years = 10
		}
	}
}

character_event = {
	id = HL.4995

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		any_realm_province = {
			any_neighbor_province = {
				holder_scope = {
					top_liege = {
						real_tier = EMPEROR
						is_nomadic = yes
						culture = ROOT
						NOT = { character = ROOT }
					}
				}
			}
		}
	}

	immediate = {
		any_realm_province = {
			any_neighbor_province = {
				holder_scope = {
					top_liege = {
						if = {
							limit = {
								real_tier = EMPEROR
								is_nomadic = yes
								culture = ROOT
								NOT = { character = ROOT }
							}

							save_event_target_as = new_nomad_liege
						}
					}
				}
			}
		}

		set_defacto_liege = event_target:new_nomad_liege

		event_target:new_nomad_liege = {
			character_event = { id = HL.4994 }
		}
	}
}

character_event = {
	id = HL.4996

	is_triggered_only = yes # on_new_holder(_usurpation)
	hide_window = yes

	trigger = {
		is_nomadic = yes

		FROM = {
			tier = COUNT

			location = {
				has_province_modifier = nomad_agitation
			}
		}
	}

	immediate = {
		FROM = {
			location = {
				remove_province_modifier = nomad_agitation
			}
		}
	}
}

character_event = {
	id = HL.4997
	title = NOMADSLEAVINGTITLE
	desc = EVTDESC_HL_4997
	picture = GFX_evt_horsemanship

	is_triggered_only = yes

	ai = no

	option = {
		name = CURSES
	}
}

character_event = {
	id = HL.4998

	is_triggered_only = yes # on_death
	hide_window = yes

	only_independent = yes

	trigger = {
		higher_tier_than = BARON
		is_nomadic = no

		any_realm_province = {
			has_province_modifier = nomad_agitation
			has_castle = no
			has_city = no
			# has_temple = no
			has_settlement_construction = no
			held_under_PREV = yes

			trigger_if = {
				limit = {
					any_province_holding = {
						holding_type = tribal
						num_of_buildings >= 2
					}
				}

				ROOT = {
					is_tribal = no
				}
			}

			ROOT = {
				NOT = { is_capital = PREV }
			}
		}

		# Can't lose the entire realm
		any_realm_province = {
			NOT = { has_province_modifier = nomad_agitation }
		}
	}

	immediate = {
		while = {
			limit = {
				any_realm_province = {
					has_province_modifier = nomad_agitation
					has_castle = no
					has_city = no
					# has_temple = no
					has_settlement_construction = no
					held_under_PREV = yes

					trigger_if = {
						limit = {
							any_province_holding = {
								holding_type = tribal
								num_of_buildings >= 2
							}
						}

						ROOT = {
							is_tribal = no
						}
					}

					ROOT = {
						NOT = { is_capital = PREV }
					}
				}
			}

			random_realm_province = {
				limit = {
					has_province_modifier = nomad_agitation
					has_castle = no
					has_city = no
					# has_temple = no
					has_settlement_construction = no
					held_under_PREV = yes

					trigger_if = {
						limit = {
							any_province_holding = {
								holding_type = tribal
								num_of_buildings >= 2
							}
						}

						ROOT = {
							is_tribal = no
						}
					}

					ROOT = {
						NOT = { is_capital = PREV }
					}
				}

				remove_province_modifier = nomad_agitation
				save_event_target_as = new_nomad_province

				county = {
					create_random_soldier = {
						random_traits = yes
						dynasty = random
						religion = PREV
						culture = PREV
						female = no
						age = 25
					}

					new_character = {
						prestige = 800
						wealth = 250
						piety = 200

						grant_title = {
							target = PREV
							type = revolt
						}

						set_defacto_liege = THIS
						set_government_type = nomadic_government
						save_event_target_as = new_nomad
					}

					create_random_soldier = {
						random_traits = yes
						dynasty = none
						religion = PREV
						culture = PREV
						female = yes
						age = 23
					}

					# Create a family
					new_character = {
						add_spouse = event_target:new_nomad
						save_event_target_as = new_nomad_wife
					}

					create_character = {
						age = 6
						religion = PREV
						culture = PREV
						female = no
					}

					new_character = {
						dynasty = event_target:new_nomad
						set_father = event_target:new_nomad
						set_mother = event_target:new_nomad_wife
					}

					create_character = {
						age = 5
						religion = PREV
						culture = PREV
						female = no
					}

					new_character = {
						dynasty = event_target:new_nomad
						set_father = event_target:new_nomad
						set_mother = event_target:new_nomad_wife
					}

					create_character = {
						age = 4
						religion = PREV
						culture = PREV
						female = yes
					}

					new_character = {
						dynasty = event_target:new_nomad
						set_father = event_target:new_nomad
						set_mother = event_target:new_nomad_wife
					}

					event_target:new_nomad = {
						population = 1000
						manpower = 250

						spawn_unit = {
							province = PREV

							troops = {
								horse_archers = { 225 225 }
								light_cavalry = { 450 450 }
								knights = { 75 75 }
							}
						}
					}
				}

				any_province_holding = {
					limit = { holding_type = tribal }
					destroy_settlement = THIS
				}
			}

			character_event = { id = HL.4997 } # Notify

			# Also usurp all same culture provinces with nomad agitation in the realm
			any_realm_province = {
				limit = {
					culture = event_target:new_nomad
					has_province_modifier = nomad_agitation
					has_castle = no
					has_city = no
					# has_temple = no
					has_settlement_construction = no
					held_under_PREV = yes

					trigger_if = {
						limit = {
							any_province_holding = {
								holding_type = tribal
								num_of_buildings >= 2
							}
						}

						ROOT = {
							is_tribal = no
						}
					}

					ROOT = {
						NOT = { is_capital = PREV }
					}
				}

				remove_province_modifier = nomad_agitation

				county = {
					grant_title = {
						target = event_target:new_nomad
						type = revolt
					}

					event_target:new_nomad = {
						population = 375
						manpower = 100

						spawn_unit = {
							province = PREV

							troops = {
								horse_archers = { 75 75 }
								light_cavalry = { 150 150 }
								knights = { 25 25 }
							}
						}
					}
				}

				any_province_holding = {
					limit = { holding_type = tribal }
					destroy_settlement = THIS
				}
			}

			event_target:new_nomad = {
				character_event = { id = HL.4995 } # Try to find neighbouring nomadic realm
			}
		}
	}
}

character_event = {
	id = HL.4999

	is_triggered_only = yes # on_new_holder(_usurpation)
	hide_window = yes

	trigger = {
		is_nomadic = no

		# NAND = {
		#	FROMFROM = {
		#		culture = ROOT
		#		is_nomadic = yes
		#	}
		#
		#	ROOT = { is_nomadic = yes }
		# }

		FROM = {
			tier = COUNT

			location = {
				has_castle = no
				has_city = no
				# has_temple = no
				has_tribal = no
				has_settlement_construction = no
				NOT = { has_province_modifier = incredibly_poor }
			}
		}
	}

	immediate = {
		if = {
			limit = {
				trigger_if = {
					limit = {
						NOT = { has_character_modifier = raiding_adventurer_nomad_timer }
					}

					is_ruler = yes
					is_landed = no
					is_offmap_governor = no # offmap governors do not become nomads
				}

				FROMFROM = {
					is_nomadic = yes
				}
			}

			# Raiding Adventurers of the same culture become Clan Chiefs
			if = {
				limit = { culture = FROMFROM }

				set_government_type = nomadic_government

				add_character_modifier = {
					name = raiding_adventurer_nomad_timer
					days = 10
					hidden = yes
				}

				FROM = {
					location = {
						any_province_holding = {
							limit = { holding_type = tribal }
							destroy_settlement = THIS
						}
					}
				}
			}
			# Raiding Adventurers of the wrong culture become Tribal Vassals
			else = {
				FROM = {
					location = {
						build_holding = {
							type = tribal
							holder = ROOT
						}

						if = {
							limit = {
								ROOT = { 
									OR = {
										culture_group = mongolic 
										culture_group = kipchak
										culture_group = karluk
										culture_group = oghur
										culture_group = arghu
										culture_group = oghuz
									} 
								 }
							}

							religion = ROOT
							culture = ROOT
						}
						else = {
							religion = FROMFROM
							culture = FROMFROM
						}
					}
				}

				set_government_type = tribal_government

				add_character_modifier = {
					name = raiding_adventurer_tribal_timer
					days = 10
					hidden = yes
				}
			}
		}
		else = {
			FROM = {
				location = {
					build_holding = {
						type = tribal
						holder = ROOT
					}

					religion = FROMFROM
					culture = FROMFROM

					add_province_modifier = {
						name = nomad_agitation
						years = 100
					}
				}
			}
		}
	}
}