namespace = HFP

# Written by Joachim
# HFP.44000 - HFP.44999

# Knights Hospitaller asks to receive an island
letter_event = {
	id = HFP.44001
	desc = EVTDESC_HFP_44001

	is_triggered_only = yes # check_holy_order_donation_effect

	immediate = {
		d_knights_hospitaller = {
			holder_scope = {
				save_event_target_as = hospitallers
			}
		}
	}

	option = {
		name = EVTOPTA_HFP_44001

		piety = 100
		scaled_wealth = 2

		reverse_opinion = {
			name = opinion_grateful
			who = event_target:hospitallers
			years = 10
		}

		reverse_opinion = {
			name = in_non_aggression_pact
			who = event_target:hospitallers
			years = 10
		}

		custom_tooltip = {
			text = EVTOPTA_HFP_44001_TT

			event_target:potential_title = {
				if = {
					limit = {
						holder_scope = {
							OR = {
								character = ROOT
								is_vassal_or_below_of = ROOT
							}
						}
					}

					if = {
						limit = { real_tier = DUKE }
						destroy_landed_title = THIS
					}
					else = {
						grant_title_no_opinion = event_target:hospitallers
					}
				}

				any_de_jure_vassal_title = {
					limit = {
						holder_scope = {
							OR = {
								character = ROOT
								is_vassal_or_below_of = ROOT
							}
						}
					}

					grant_title_no_opinion = event_target:hospitallers
				}
			}

			event_target:hospitallers = {
				any_demesne_title = {
					limit = {
						trigger_if = {
							limit = { lower_real_tier_than = DUKE }
							NOT = { holding_type = castle }
						}
						trigger_else = {
							NOT = { title = d_knights_hospitaller }
						}
					}

					if = {
						limit = { tier = BARON }

						if = {
							limit = { holding_type = city }

							create_random_steward = {
								random_traits = yes
								dynasty = random
							}
						}
						else = {
							create_random_priest = {
								random_traits = yes
								dynasty = random
							}
						}
					}
					else = {
						create_random_soldier = {
							random_traits = yes
							dynasty = random
						}
					}

					grant_title_no_opinion = new_character
				}
			}

			d_knights_hospitaller = {
				set_name = knights_hospitaller_island_rename
			}

			event_target:potential_title = {
				capital_scope = {
					event_target:hospitallers = {
						if = {
							limit = {
								has_landed_title = PREV
								event_target:potential_title = {
									tier = DUKE
								}
							}
							capital = PREV
						}
						else = {
							capital = event_target:potential_title
						}
					}
				}
			}

			narrative_event = { id = HFP.44004 }

			event_target:hospitallers = {
				character_event = { id = HFP.41090 days = 1 }
				character_event = { id = HFP.41090 days = 3 }
			}
		}
	}

	option = {
		name = EVTOPTB_HFP_44001

		piety = -25
		set_character_flag = refused_to_give_island_to_knights

		ai_chance = { factor = 0 }
	}
}

# Narrative event for the Knights Hospitallers
narrative_event = {
	id = HFP.44004
	title = EVTTITLE_HFP_44004
	desc = EVTDESC_HFP_44004
	picture = GFX_evt_magnificent_castle
	border = GFX_event_narrative_frame_religion

	is_triggered_only = yes
	major = yes

	major_trigger = {
		ai = no
	}

	option = {
		name = EVTOPTA_HFP_44004
	}
}

# Holy Order decides their liege is unfit to rule over them
character_event = {
	id = HFP.44002

	is_triggered_only = yes # on_yearly_pulse
	hide_window = yes

	ai = yes

	trigger = {
		holy_order = yes
		independent = no
	}

	immediate = {
		liege = {
			save_event_target_as = liege_character
		}

		if = {
			limit = {
				OR = {
					opinion = {
						who = liege
						value < -20
					}

					liege = {
						OR = {
							excommunicated_for = ROOT
							NOT = { religion = ROOT }
						}
					}
				}
			}

			opinion = {
				name = opinion_unfit_ruler
				who = event_target:liege_character
				years = 30
			}

			liege = {
				letter_event = { id = HFP.44003 }
			}

			any_demesne_title = {
				limit = {
					holy_order = no

					any_dejure_liege = {
						holder_scope = {
							OR = {
								character = event_target:liege_character

								AND = {
									is_vassal_or_below_of = event_target:liege_character
									NOT = { character = ROOT }
								}
							}
						}
					}
				}

				grant_title_no_opinion = event_target:liege_character
			}

			set_defacto_liege = THIS
		}
	}
}

# Letter informing the previous liege of a Holy Order that the Holy Order has left his / her service
letter_event = {
	id = HFP.44003
	desc = EVTDESC_HFP_44003
	border = GFX_event_letter_frame_religion

	is_triggered_only = yes

	option = {
		name = EVTOPTA_HFP_44003

		piety = -50
	}
}