namespace = salvation


# The son of a ruler volunteers to join the Holy Order
character_event = {
	id = salvation.5
	hide_window = yes
	
	only_men = yes
	min_age = 16
	max_age = 45
	only_capable = yes
	prisoner = no
	
	trigger = {
		is_ruler = no
		has_dlc = "Sons of Abraham"
		NAND = {
			has_secret_religion = yes
			trait = zealous
		}
		AND = {
			NOT = { has_character_modifier = expelled_d_army_salvation }
			NOT = {
				any_liege = {
					has_character_modifier = expelled_d_army_salvation
				}
			}
			is_title_active = d_army_salvation
			OR = {
				religion = anglican
				society_member_of = monastic_order_methodist
			}
		}
		is_heretic = no
		
		martial = 5
		
		OR = {
			father_even_if_dead = {
				primary_title = { higher_tier_than = BARON }
			}
			mother_even_if_dead = {
				primary_title = { higher_tier_than = BARON }
			}
		}
		
		liege = {
			holy_order = no
			NOT = { government = order_government }
			religion = ROOT
			liege = {
				holy_order = no
				NOT = { government = order_government }
				liege = {
					holy_order = no
					NOT = { government = order_government }
				}
			}
		}
		
		NOT = {
			any_spouse = {
				OR = {
					is_landed = yes
					AND = {
						is_pregnant = yes
					father_of_unborn = { character = ROOT } # Won't happen if spouse is pregnant with non-bastard child
					}
				}
			}
		}
	}
	
	mean_time_to_happen = {
		years = 100
		modifier = {
			factor = 0.25
			trait = zealous
		}
		modifier = {
			factor = 0.5
			trait = celibate
		}
		modifier = {
			factor = 0.5
			trait = homosexual
		}
		modifier = {
			factor = 0.7
			trait = content
		}
		modifier = {
			factor = 0.75
			trait = chaste
		}
		modifier = {
			factor = 0.75
			NOT = { age = 25 }
		}
		modifier = {
			factor = 1.5
			trait = slothful
		}
		modifier = {
			factor = 2.0
			trait = lustful
		}
		modifier = {
			factor = 2.0
			trait = cynical
		}
		modifier = {
			factor = 5.0
			has_secret_religion = yes
			NOT = { trait = cynical }
		}
		modifier = {
			factor = 2.0
			trait = hedonist
		}
		modifier = {
			factor = 2.0
			trait = ambitious
		}
		modifier = {
			factor = 2.0
			any_heir_title = {
				always = yes
			}
		}
		modifier = {
			factor = 2.0
			is_primary_heir = yes
		}
		modifier = {
			factor = 2
			any_spouse = {
				reverse_opinion = { who = ROOT value = 100 }
			}
		}
		modifier = {
			factor = 0.5
			society_member_of = monastic_order_methodist
		}
	}
	
	immediate = {
		trigger = {
			NOT = { has_character_modifier = expelled_d_army_salvation }
			NOT = {
				any_liege = {
					has_character_modifier = expelled_d_army_salvation
				}
			}
			is_title_active = d_army_salvation
			OR = {
				religion = anglican
				society_member_of = monastic_order_methodist
			}
		}
		d_army_salvation = { save_event_target_as = holy_order_to_join }
		liege = {
			character_event = {
				id = salvation.6
			}
		}
	}
}

# Son or brother asks to join the Holy Order
character_event = {
	id = salvation.6
	desc = EVTDESC_HOLY_ORDER_6
	picture = GFX_evt_crusaders
	border = GFX_event_normal_frame_religion
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOA_1031 # Agree
		ai_chance = {
			factor = 100
		}
		
		if = {
			limit = {
				religion = FROM
			}
			piety = 100
		}
		
		FROM = {
			character_event = {
				id = salvation.7
				tooltip = EVTTOOLTIP_HOLY_ORDER_7
			}
		}
	}
	
	option = {
		name = EVTOPTB_SOA_1031 # Refuse
		
		if = {
			limit = {
				religion = FROM
			}
			piety = -100
		}
		
		FROM = {
			character_event = {
				id = salvation.8
				tooltip = EVTTOOLTIP_SOA_1033
			}
		}
	}
}

# Son or brother joins the Holy Order
character_event = {
	id = salvation.7
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		event_target:holy_order_to_join = {
			holder_scope = {
				save_event_target_as = order_target
				ROOT = {
					character_event = { id = SoA.2864 }
				}
			}
		}
	}
}

# Liege refuses request to join Holy Order
character_event = {
	id = salvation.8
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		opinion = {
			who = FROM
			modifier = opinion_refused_request_holy_order
		}
	}
}
character_event = {
	id = salvation.9
	hide_window = yes
	
	is_triggered_only = yes
	religion = catholic
	trigger = {
		controls_religion = yes
	}
	immediate = {
		#zarist = { save_persistent_event_target = { name = one_holy_order scope = d_white_army } }
	}
}

# The Grand Master humbly requests the right to build a castle in your demesne
character_event = {
	id = salvation.10
	hide_window = yes
	
	min_age = 16
	only_playable = yes
	
	trigger = {
		AND = {
			NOT = { has_character_modifier = expelled_d_army_salvation }
			NOT = {
				any_liege = {
					has_character_modifier = expelled_d_army_salvation
				}
			}
			d_army_salvation = {
				holder_scope = { ai = yes
					wealth = 300
					NOT = {
						realm_size = 10
					}
				}
			}
			religion = anglican
		}
		NOT = { government = order_government }
		holy_order = no
		liege = {
			holy_order = no
			NOT = { government = order_government }
			liege = {
				holy_order = no
				NOT = { government = order_government }
			}
		}
		is_heretic = no
		top_liege = {
			religion = ROOT
		}
		any_demesne_province = {
			has_empty_holding = yes
		}
		
		has_dlc = "Sons of Abraham"
	}
	
	mean_time_to_happen = {
		months = 960
		modifier = {
			factor = 0.5
			AND = {
				NOT = { has_character_modifier = expelled_d_army_salvation }
				NOT = {
					any_liege = {
						has_character_modifier = expelled_d_army_salvation
					}
				}
				d_army_salvation = {
					holder_scope = { ai = yes
						NOT = { demesne_size = 1 } wealth = 300
					}
				}
				religion = anglican
			}
		}
		modifier = {
			factor = 0.5
			OR = {
				AND = {
					NOT = { has_character_modifier = expelled_d_army_salvation }
					NOT = {
						any_liege = {
							has_character_modifier = expelled_d_army_salvation
						}
					}
					d_army_salvation = {
						holder_scope = { ai = yes
							NOT = { demesne_size = 2 } wealth = 300
						}
					}
					religion = anglican
				}
			}
		
		}
		modifier = {
			factor = 0.5
			AND = {
				NOT = { has_character_modifier = expelled_d_army_salvation }
				NOT = {
					any_liege = {
						has_character_modifier = expelled_d_army_salvation
					}
				}
				d_army_salvation = {
					holder_scope = { ai = yes
						NOT = { num_of_count_titles = 1 } wealth = 300
					}
				}
				OR = {
					religion = catholic
					religion = cadaverist
					religion = fraticelli
				}
			}
		}
		modifier = {
			factor = 0.5
			AND = {
				NOT = { has_character_modifier = expelled_d_army_salvation }
				NOT = {
					any_liege = {
						has_character_modifier = expelled_d_army_salvation
					}
				}
				d_army_salvation = {
					holder_scope = { ai = yes
						NOT = { realm_size = 5 } wealth = 300
					}
				}
				OR = {
					religion = catholic
					religion = cadaverist
					religion = fraticelli
				}
			}
		}
		modifier = {
			factor = 0.66
			society_member_of = monastic_order_methodist
		}
	}
	
	immediate = {
			trigger = {
				NOT = { has_character_modifier = expelled_d_army_salvation }
				NOT = {
					any_liege = {
						has_character_modifier = expelled_d_army_salvation
					}
				}
				d_army_salvation = {
					holder_scope = { ai = yes
						wealth = 300
						NOT = {
							realm_size = 10
						}
					}
				}
				religion = anglican
			}
			modifier = {
				factor = 5
				any_province = {
					region = world_europe_west_britannia
					has_empty_holding = yes
				}
			}
			modifier = {
				factor = 3
				d_army_salvation = { holder_scope = { NOT = { demesne_size = 1 } } }
			}
			modifier = {
				factor = 3
				d_army_salvation = { holder_scope = { NOT = { demesne_size = 2 } } }
			}
			modifier = {
				factor = 3
				d_army_salvation = { holder_scope = { NOT = { num_of_count_titles = 1 } } }
			}
			modifier = {
				factor = 3
				d_army_salvation = { holder_scope = { NOT = { demesne_size = 5 } } }
			}
			d_army_salvation = { save_event_target_as = holy_order_to_build }
		
		}
		random_demesne_province = {
			limit = {
				has_empty_holding = yes
			}
			preferred_limit = {
				region = world_europe_west_britannia
				event_target:holy_order_to_build = { title = d_army_salvation }
			}
			province_event = {
				id = salvation.11
			}
		}
	}
}

province_event = {
	id = salvation.11
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		event_target:holy_order_to_build = {
			holder_scope = {
				character_event = {
					id = salvation.12
				}
			}
		}
	}
}

character_event = {
	id = salvation.12
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		FROMFROM = {
			letter_event = {
				id = salvation.13
			}
		}
	}
}

letter_event = {
	id = salvation.13
	desc = EVTDESC_HOLY_ORDER_13
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOA_1023 # Agree
		ai_chance = {
			factor = 80
			modifier = {
				factor = 2
				trait = zealous
				has_secret_religion = no
			}
			modifier = {
				factor = 0.5
				trait = cynical
				has_secret_religion = no
			}
			modifier = {
				factor = 0.5
				has_secret_religion = yes
			}
			modifier = {
				factor = 1.5
				trait = trusting
			}
			modifier = {
				factor = 0.5
				trait = paranoid
			}
		}
		
		hidden_tooltip = {
			FROM = {
				character_event = { id = salvation.22 }
			}
			FROMFROM = {
				province_event = { id = salvation.14 }
			}
		}
		
		piety = 200
		wealth = 100
	}
	
	option = {
		name = EVTOPTB_SOA_1153 # Refuse
		ai_chance = {
			factor = 20
		}
		hidden_tooltip = {
			FROM = {
				letter_event = { id = salvation.21 }
			}
		}
		piety = -100
	}
}

# Castle has been erected
province_event = {
	id = salvation.14
	desc = EVTDESC_HOLY_ORDER_14
	picture = GFX_evt_castle_construction
	border = GFX_event_normal_frame_religion
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOA_1024
	}
}

character_event = {
	id = salvation.15
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		wealth = 300
		FROM = {
			letter_event = {
				id = salvation.16
			}
		}
		opinion = {
			who = FROM
			modifier = opinion_generous_donation
		}
	}
}

# Notification event when donating money Holy Order
letter_event = {
	id = salvation.16
	desc = EVTDESC_HOLY_ORDER_16
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes
	
	option = {
		name = EXCELLENT
	}
}

# Ping event when expelling a Holy Order
character_event = {
	id = salvation.17
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		any_title_under = {
			limit = {
				tier = BARON
				location = {
					owner = {
						OR = {
							character = FROM
							is_liege_or_above = FROM
						}
					}
				}
			}
			usurp_title = FROM
		}
		
		if = {
			limit = {
				is_liege_or_above = FROM
			}
			set_defacto_liege = THIS
		}
	
		FROM = {
			letter_event = {
				id = salvation.18
			}
		}
		
		opinion = {
			who = FROM
			modifier = opinion_expelled_from_realm
		}
	}
}

# Notification event when expelling a Holy Order
letter_event = {
	id = salvation.18
	desc = EVTDESC_HOLY_ORDER_18
	
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes
	
	immediate = {
		remove_character_modifier = donated_to_holy_order
	}
	
	option = {
		name = EVTOPTB_SOA_1061
	}
}

character_event = {
	id = salvation.19
	desc = "DEBUG"
	picture = GFX_evt_pagan_reformation
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { religion = FROMFROM }
		FROMFROM = {
			has_character_modifier = expelled_d_army_salvation
			primary_title = { title = ROOT_FROM  }
		}
	}

	immediate = {
		FROMFROM = {
			conversion_check_holy_order_modifiers_effect = yes
		}
	}
}

character_event = {
	id = salvation.20
	desc = "DEBUG"
	picture = GFX_evt_pagan_reformation
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_character_modifier = expelled_d_army_salvation
		OR = {
			is_ruler = no
			independent = no
		}
	}

	immediate = {
		set_character_flag = coversion_keep_debt
		conversion_check_holy_order_modifiers_effect = yes
	}
}

letter_event = {
	id = salvation.21
	desc = EVTDESC_HOLY_ORDER_21
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_HOLY_ORDER_21
		opinion = {
			modifier = refused_castle_construction who = FROM years = 10
		}
	}
}

character_event = {
	id = salvation.22
	desc = EVTDESC_HOLY_ORDER_22
	picture = GFX_evt_castle_construction
	border = GFX_event_normal_frame_religion
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOA_1024
		opinion = {
			modifier = accepted_castle_construction who = FROM years = 5
		}
		wealth = -300
		if = {
			limit = {
				realm_size = 10
			}
			piety = -200
		}
		FROMFROMFROM = {
			show_scope_change = no
			build_holding = {
			   type = castle
			   holder = ROOT
			}
		}
	}
}

character_event = {
	id = salvation.23
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		FROM = {
			location = {
				province_event = { id = salvation.11 days = 3 random = 3 }
			}
		}
	}
}

narrative_event = { #Founding
	id = salvation.24
	title = "EVTTITLE_ANGLICAN_HOLY_24"
	desc = "EVTDESC_ANGLICAN_HOLY_24"
	picture = "GFX_evt_crusaders"
	border = "GFX_event_narrative_frame_religion"
	
	major = yes
	only_playable = yes
		
	trigger = {
		OR= {
			has_landed_title = k_britannia
			has_landed_title = e_britannia
		}
#		2571 = { #London
#			owner = {
#				religion = ROOT
#				OR = {
#					same_realm = ROOT
#					character = ROOT
#				}
#			}
#		}
#		is_heretic = no
		religion = anglican
		NOT = { is_title_active = d_army_salvation }
	}
		
	mean_time_to_happen = {
		months = 4
	}
	
	immediate = {
		activate_title = { title = d_army_salvation status = yes }
		create_character = {
			name = "William-Booth"
			dynasty = random
			random_traits = yes
			trait = zealous
			trait = charitable
			religion = ROOT
			culture = westlander
			female = no
		}
		new_character = {
			d_army_salvation = {
				religion = ROOT
				grant_title = PREV
			}
			set_defacto_liege = ROOT
			new_order_effect = yes
		}
		
		religion_authority = {
			modifier = religious_order_formed
			years = 10
		}
	}
	option = {
		name = "EVTOPTA_ANGLICAN_HOLY_24"
		trigger = {
			religion = ROOT
		}
	}
	option = {
		name = "EVTOPTB_ANGLICAN_HOLY_24"
		trigger = {
			NOT = { religion_group = christian }
		}
	}
	option = {
		name = "EVTOPTC_ANGLICAN_HOLY_24"
		trigger = {
			religion_group = christian
			NOT = { religion = ROOT }
		}
	}
}